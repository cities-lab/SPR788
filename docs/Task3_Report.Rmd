---
title: "SPR 788: Task 3 & 4 Updates"
author: "Liming Wang"
date: "3/22/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=F)
options(scipen=100)
options(digits=3)

if (!require("pacman")) {install.packages("pacman"); library(pacman)}
# special installation process for printr as it is not available on CRAN
if (!require("printr")) install.packages('printr', type = 'source', 
                                         repos = 'http://yihui.name/xran')
pacman::p_load(tidyverse)
```

## Tasks 

### Task 3: Model implementation
> PSU researchers shall select an optimal model design from Task 2, based on TAC/OSA input, and implement it using R as a package for the unified RSPM framework. The result will be a new functionality in RSPM that can be applied across several Oregon and national tools. The implementation of the new functionality will be checked in by the PSU researchers to a shared code repository and estimation data properly documented

### Task 4: Mode testing
> PSU researchers shall apply the newly incorporated mode shift module (in the updated RSPM tool) in the Corvallis Area Metropolitan Planning Organization (CAMPO) to assess how it can inform decision-making and to adjust the model as needed to provide accurate and helpful information.  ODOT staff will assist in assembling the necessary data for sensitivity test.  Initial testing will be documented by the PSU researchers.

## Progress

### Task 3: VETravelDemand (VisionEval Travel Demand) Implementation

1. [DONE] initial implementation as an R package
    - Implemented as a module (R Package) for the VisionEval framework that provides functions to predict AADVMT and TFL for transit, walk, and bike
    - Following the VisionEval package guidelines and including code, data (estimated model objects with parameters), documents, and tests

1. [DONE] Light-weight implementation
    - Utilizing list-column data frames to avoid the need to iterate/loop through segments (i.e., metro and non-metro segments)
    - Taking advantage of predict() function call of R model objects
    - Implementation is almost agnostic to the model structure used
    - Code for the PredictAADVMT function:

```{r, eval=F, include=T}
#=======================================================
#SECTION 3: DEFINE FUNCTIONS THAT IMPLEMENT THE SUBMODEL
#=======================================================

#Main module function that predicts AADVMT for households
#------------------------------------------------------
#' Main module function
#'
#' \code{PredictAADVMT} predicts AADVMT for each household in the households
#' dataset using independent variables including household characteristics
#' and 5D built environment variables.
#'
#' This function predicts AADVMT for each hosuehold in the model region where
#' each household is assigned an AADVMT. The model objects as a part of the
#' inputs are stored in data frame with two columns: a column for segmentation
#' (e.g., metro, non-metro) and a 'model' column for model object (list-column
#' data structure). The function "nests" the households data frame into a
#' list-column data frame by segments and applies the generic predict() function
#' for each segment to predict AADVMT for each household. The vectors of HhId
#' and AADVMT produced by the PredictAADVMT function are to be stored in the
#' "Household" table.
#'
#' Since this table does not exist, the function calculates a LENGTH value for
#' the table and returns that as well. The framework uses this information to
#' initialize the Households table. The function also computes the maximum
#' numbers of characters in the HhId and Azone datasets and assigns these to a
#' SIZE vector. This is necessary so that the framework can initialize these
#' datasets in the datastore. All the results are returned in a list.
#'
#' @param L A list containing the components listed in the Get specifications
#' for the module. (Q: what about a model object?)
#' @return A list containing the components specified in the Set
#' specifications for the module along with:
#' LENGTH: A named integer vector having a single named element, "Household",
#' which identifies the length (number of rows) of the Household table to be
#' created in the datastore.
#' SIZE: A named integer vector having two elements. The first element, "Azone",
#' identifies the size of the longest Azone name. The second element, "HhId",
#' identifies the size of the longest HhId.
#' @import tidyverse
#' @export
PredictAADVMT <- function(L) {
  Model_df <- L$model
  # colname used for segmenting households ("metro" by default)
  SegmentCol_vc <- setdiff(names(Model_df), "model")
  Household_df <- L$Household_df

  stopifnot(SegmentCol_vc %in% names(Household_df))

  Hh_lcdf <- Household_df %>% group_by_(SegmentCol_vc) %>%
    nest() %>%
    left_join(Model_df)

  Out_df <- Hh_lcdf %>% mutate(HhId=map(data, "HhId"),
                               AADVMT=map2(model, data, predict, type="response")) %>%
    unnest(HhId, AADVMT)
  Out_ls <- list(HhId=Out_df$HhId,
                 AADVMT=Out_df$AADVMT)
  #Calculate LENGTH attribute for Household table

  Out_ls$LENGTH <- numeric(0)
  Out_ls$LENGTH["Household"] <- length(Out_ls$HhId)
  #Calculate SIZE attributes for 'Azone' and 'HhId'
  Out_ls$SIZE <- numeric(0)
  Out_ls$SIZE["HhId"] <- max(nchar(Out_ls$HhId))
  Out_ls$SIZE["AADVMT"] <- max(nchar(Out_ls$AADVMT))

  #Return the list
  Out_ls
}

```

1. [DONE] Module testing
    - Implemented in tests/test_modules.R
    - All functions implemented in the module tested with 2009 NHTS + SLD data

1. [TODO] Further modifications in response to changes in VisionEval
    - Variable name registration
    - Changes in data structure return from data store

1. [TODO] Release module as a public repository
    - Package available at a private repository https://github.com/cities-lab/RSPM_ModeChoice/module, may split into a separate repository
    - Current tests using 2009 NHTS joined with SLD, which may violate FHWA's confidentality agreement if released
    - Test data to be replaced with RVMPO synthesized households joined with SLD (see below)

### Task 4: Model testing
1. [DONE] RVMPO Test region (switched from CAMPO)
    - Data for the RVMP baseline scenario retrieved
    - Uses block group geography; Brian helped assign synthesized households to block groups
    - Utilizes RVMPO place types designation (TAZ)

1. [Ongoing] Phased model testing
    i. Run VETravelDemand module alone with RVMPO base year data + SLD information; predictions will be compared with OTAS/HPMS and RSPM VMT prediction;
    i. Run VETravelDemand module alone with RVMPO base year data + place types and selected independent variables (e.g. population and employment density); Any missing 5D independent variables are to be extrapolated from place types densignation of block groups; predictions will be compared with OTAS/HPMS and RSPM prediction (VMT);
    i. Run VETravelDemand module along with other RSPM modules (requiring a wrapper that enables VisionEval modules to run with RSMP modules)
